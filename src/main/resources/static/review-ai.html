<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI评论分析</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --light-color: #f5f5f5;
            --border-color: #ddd;
            --text-color: #333;
            --text-light: #777;
        }

        .ai-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .ai-section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-summary {
            line-height: 1.6;
            white-space: pre-line;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }

        .ai-guide {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2196F3;
            margin-bottom: 15px;
        }

        .btn-refresh {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-refresh:hover {
            background: var(--secondary-color);
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--text-light);
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        .sentiment-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }

        .sentiment-positive {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .sentiment-negative {
            background-color: #ffebee;
            color: #c62828;
        }

        .sentiment-neutral {
            background-color: #f5f5f5;
            color: #616161;
        }

        .guide-options {
            margin-bottom: 15px;
        }

        .guide-options label {
            margin-right: 10px;
            font-weight: bold;
        }

        .guide-options select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-right: 15px;
            min-width: 120px;
        }

        .guide-options button {
            padding: 8px 15px;
        }

        .message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<h2 class="section-title">AI评论分析工具</h2>

<!-- 评论摘要部分 -->
<div class="ai-section" id="summary-section">
    <div class="ai-section-title">
        <span>评论智能摘要</span>
        <button id="refresh-summary" class="btn-refresh">刷新摘要</button>
    </div>
    <div id="summary-message" class="message"></div>
    <div id="summary-content">
        <div class="loading-indicator">
            <div class="loading-spinner"></div>
            <span>正在生成评论摘要...</span>
        </div>
    </div>
</div>

<!-- 评论引导部分 -->
<div class="ai-section">
    <div class="ai-section-title">
        <span>评论智能引导</span>
    </div>
    <div id="guide-message" class="message"></div>
    <div class="guide-options">
        <label for="dish-selector">选择菜品:</label>
        <select id="dish-selector">
            <option value="">不针对特定菜品</option>
            <!-- 菜品将通过JavaScript动态加载 -->
        </select>

        <label for="type-selector">商铺类型:</label>
        <select id="type-selector">
            <option value="">不指定类型</option>
            <option value="中餐">中餐</option>
            <option value="西餐">西餐</option>
            <option value="火锅">火锅</option>
            <option value="烧烤">烧烤</option>
            <option value="甜品">甜品</option>
            <option value="快餐">快餐</option>
        </select>

        <button id="generate-guide" class="btn-refresh">生成引导</button>
    </div>
    <div id="guide-content">
        <p>请选择菜品或商铺类型，然后点击"生成引导"按钮获取评论引导。</p>
    </div>
</div>

<script>
    // 当前餐厅ID
    let currentRestaurantId = null;

    // 初始化函数
    function initAiReviewTools(restaurantId) {
        currentRestaurantId = restaurantId;

        // 加载评论摘要
        loadReviewSummary();

        // 加载餐厅菜品列表（用于评论引导）
        loadRestaurantDishes();

        // 设置事件监听器
        document.getElementById('refresh-summary').addEventListener('click', refreshSummary);
        document.getElementById('generate-guide').addEventListener('click', generateGuide);
    }

    // 加载评论摘要
    function loadReviewSummary() {
        if (!currentRestaurantId) {
            showSummaryMessage('error', '无法获取餐厅信息');
            return;
        }

        document.getElementById('summary-content').innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <span>正在加载评论摘要...</span>
                </div>
            `;

        // 使用异步API获取摘要
        fetchWithTokenHandling(`/api/reviews/analysis/summary/${currentRestaurantId}/async`)
            .then(response => {
                if (response.success) {
                    displaySummary(response.data);
                } else {
                    throw new Error(response.message || '加载失败');
                }
            })
            .catch(error => {
                console.error('加载评论摘要失败:', error);
                showSummaryMessage('error', `加载评论摘要失败: ${error.message || error}`);
                document.getElementById('summary-content').innerHTML = '<p>无法加载评论摘要，请稍后再试。</p>';
            });
    }

    // 刷新评论摘要
    function refreshSummary() {
        if (!currentRestaurantId) {
            showSummaryMessage('error', '无法获取餐厅信息');
            return;
        }

        document.getElementById('summary-content').innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <span>正在刷新评论摘要...</span>
                </div>
            `;

        // 使用刷新API
        fetchWithTokenHandling(`/api/reviews/analysis/summary/${currentRestaurantId}/refresh`, {
            method: 'POST'
        })
            .then(response => {
                if (response.success) {
                    displaySummary(response.data);
                    showSummaryMessage('success', '评论摘要已成功刷新！');
                } else {
                    throw new Error(response.message || '刷新失败');
                }
            })
            .catch(error => {
                console.error('刷新评论摘要失败:', error);
                showSummaryMessage('error', `刷新评论摘要失败: ${error.message || error}`);
                document.getElementById('summary-content').innerHTML = '<p>刷新评论摘要失败，请稍后再试。</p>';
            });
    }

    // 显示评论摘要
    function displaySummary(summaryData) {
        // 将摘要显示在页面上
        document.getElementById('summary-content').innerHTML = `
                <div class="ai-summary">
                    ${summaryData}
                </div>
            `;
    }

    // 加载餐厅的菜品列表
    function loadRestaurantDishes() {
        if (!currentRestaurantId) return;

        // 假设有一个API来获取餐厅菜品
        fetchWithTokenHandling(`/api/dishes?restaurantId=${currentRestaurantId}`)
            .then(response => {
                if (response.success && Array.isArray(response.data)) {
                    const dishSelector = document.getElementById('dish-selector');
                    // 清除除了第一个选项外的所有选项
                    while (dishSelector.options.length > 1) {
                        dishSelector.remove(1);
                    }

                    // 添加菜品选项
                    response.data.forEach(dish => {
                        const option = document.createElement('option');
                        option.value = dish.name;
                        option.textContent = dish.name;
                        dishSelector.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('加载菜品列表失败:', error);
            });
    }

    // 生成评论引导
    function generateGuide() {
        const dishValue = document.getElementById('dish-selector').value;
        const typeValue = document.getElementById('type-selector').value;

        if (!dishValue && !typeValue) {
            showGuideMessage('error', '请至少选择一个菜品或商铺类型');
            return;
        }

        document.getElementById('guide-content').innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <span>正在生成评论引导...</span>
                </div>
            `;

        // 构建查询参数
        const queryParams = new URLSearchParams();
        if (dishValue) queryParams.append('dish', dishValue);
        if (typeValue) queryParams.append('type', typeValue);

        // 调用API生成引导
        fetchWithTokenHandling(`/api/reviews/guide?${queryParams.toString()}`)
            .then(response => {
                if (response.success) {
                    document.getElementById('guide-content').innerHTML = `
                            <div class="ai-guide">${response.data}</div>
                            <button id="copy-guide" class="btn-refresh" onclick="copyGuideContent()">复制内容</button>
                        `;
                    showGuideMessage('success', '引导生成成功！');
                } else {
                    throw new Error(response.message || '生成失败');
                }
            })
            .catch(error => {
                console.error('生成评论引导失败:', error);
                showGuideMessage('error', `生成评论引导失败: ${error.message || error}`);
                document.getElementById('guide-content').innerHTML = '<p>生成评论引导失败，请稍后再试。</p>';
            });
    }

    // 复制引导内容
    function copyGuideContent() {
        const guideElement = document.querySelector('.ai-guide');
        if (!guideElement) return;

        const textToCopy = guideElement.innerText;

        // 创建一个临时textarea来复制文本
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        document.body.appendChild(textarea);
        textarea.select();

        try {
            const successful = document.execCommand('copy');
            showGuideMessage('success', '评论引导已复制到剪贴板！');
        } catch (err) {
            showGuideMessage('error', '复制失败，请手动复制');
            console.error('复制失败:', err);
        }

        document.body.removeChild(textarea);
    }

    // 显示摘要相关的消息
    function showSummaryMessage(type, message) {
        const messageElement = document.getElementById('summary-message');
        messageElement.textContent = message;
        messageElement.className = `message ${type}`;

        // 5秒后自动隐藏成功消息
        if (type === 'success') {
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    }

    // 显示引导相关的消息
    function showGuideMessage(type, message) {
        const messageElement = document.getElementById('guide-message');
        messageElement.textContent = message;
        messageElement.className = `message ${type}`;

        // 5秒后自动隐藏成功消息
        if (type === 'success') {
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
    }

    // 页面可能被作为嵌入内容加载，所以导出初始化函数
    window.initAiReviewTools = initAiReviewTools;
</script>
</body>
</html>